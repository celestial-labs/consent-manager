___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Consent Manager (Digital-Masters)",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "Dm CookieConsent",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "mode",
    "displayName": "Job",
    "selectItems": [
      {
        "value": "init",
        "displayValue": "init"
      },
      {
        "value": "update",
        "displayValue": "update"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "remotescript",
    "displayName": "Remotescript",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "script",
        "displayName": "Cookie Consent Script",
        "simpleValueType": true,
        "defaultValue": "https://celestialtechlabs.com/ccm.js"
      },
      {
        "type": "TEXT",
        "name": "wait_for_update",
        "displayName": "Wait For Update",
        "simpleValueType": true,
        "defaultValue": 2000,
        "valueUnit": "Millisekunden",
        "valueHint": "500"
      },
      {
        "type": "TEXT",
        "name": "options",
        "displayName": "Options",
        "simpleValueType": true,
        "valueValidators": []
      }
    ],
    "enablingConditions": [
      {
        "paramName": "mode",
        "paramValue": "init",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "PARAM_TABLE",
    "name": "consent_types_defaults",
    "displayName": "Google Consent Types (Defaultwerte)",
    "paramTableColumns": [
      {
        "param": {
          "type": "RADIO",
          "name": "ad_storage",
          "displayName": "ad_storage",
          "radioItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "RADIO",
          "name": "analytics_storage",
          "displayName": "analytics_storage",
          "radioItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "RADIO",
          "name": "functionality_storage",
          "displayName": "functionality_storage",
          "radioItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "RADIO",
          "name": "personalization_storage",
          "displayName": "personalization_storage",
          "radioItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "RADIO",
          "name": "security_storage",
          "displayName": "security_storage",
          "radioItems": [
            {
              "value": "granted",
              "displayValue": "granted"
            },
            {
              "value": "denied",
              "displayValue": "denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "denied"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "TEXT",
          "name": "region",
          "displayName": "Region",
          "simpleValueType": true
        },
        "isUnique": false
      }
    ],
    "enablingConditions": [
      {
        "paramName": "mode",
        "paramValue": "init",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "eventdata",
    "simpleValueType": true,
    "displayName": ""
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const JSON = require('JSON');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const isConsentGranted = require('isConsentGranted');
const callInWindow = require('callInWindow');



  log(data, data.payload);
if(data.mode === 'update') {
  updateConsentState({
    ad_storage: 'granted',
    analytics_storage:'granted',
    functionality_storage: 'granted',
    personalization_storage: 'granted',
    security_storage: 'granted',
  });
}

if(data.mode === 'init') { 


const prepareConsentData = function (rawConsentData) {
        let defaultData = {
            ad_storage: rawConsentData.ad_storage,
            analytics_storage: rawConsentData.analytics_storage,
            functionality_storage: rawConsentData.functionality_storage,
            personalization_storage: rawConsentData.personalization_storage,
            security_storage: rawConsentData.security_storage,
            wait_for_update: data.wait_for_update
        };

        if(rawConsentData.region && rawConsentData.region !== "") {
            defaultData.region = rawConsentData.region.split(',').map(r => r.trim());
        }

        return defaultData;
};

data.consent_types_defaults = data.consent_types_defaults ? data.consent_types_defaults : [];
data.consent_types_defaults.forEach(consentData => {
  setDefaultConsentState(prepareConsentData(consentData));
});

// setDefaultConsentState(prepareConsentData(data.consent_types_defaults));
// log('isConsentGranted =', isConsentGranted('security_storage'));


const script = data.script;

if (queryPermission('inject_script', script)) {
    injectScript(script, function (scriptUrl) {
      callInWindow('ConsentManager.gTagParseOptions', JSON.parse(data.options));
      callInWindow('ConsentManager.run');
    }, data.gtmOnFailure);
    
} else {
    data.gtmOnFailure();
}

}


data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://ecstatic-edison-185003.netlify.app/*"
              },
              {
                "type": 1,
                "string": "https://celestialtechlabs.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ConsentManager.run"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ConsentManager.gTagParseOptions"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: it call not setDefaultConsentState
  code: |-
    const testData = {};
    mock('setDefaultConsentState');

    runCode(testData);
    assertApi('setDefaultConsentState').wasNotCalled();
- name: it call setDefaultConsentState
  code: |-
    const testData = {
      "wait_for_update": 1000,
      "consent_types_defaults": [{
        "ad_storage":"granted",
        "analytics_storage":"granted",
        "functionality_storage":"denied",
        "personalization_storage":"denied",
        "security_storage":"denied",
        "region":""
      } ,{
        "ad_storage": "granted",
         "analytics_storage":"granted",
         "functionality_storage":"granted",
         "personalization_storage":"granted",
         "security_storage":"granted",
         "region":"US, EN"
        }]
    };
    mock('setDefaultConsentState');


    // Call runCode to run the template's code.
    runCode(testData);
    assertApi('setDefaultConsentState').wasCalled();
    assertApi('setDefaultConsentState').wasCalledWith({
        "ad_storage":"granted",
        "analytics_storage":"granted",
        "functionality_storage":"denied",
        "personalization_storage":"denied",
        "security_storage":"denied",
        "wait_for_update": 1000
    });
    assertApi('setDefaultConsentState').wasCalledWith({
        "ad_storage":"granted",
        "analytics_storage":"granted",
        "functionality_storage":"granted",
        "personalization_storage":"granted",
        "security_storage":"granted",
        "region": ['US', 'EN'],
        "wait_for_update": 1000
    });

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: ''


___NOTES___

Created on 18.1.2022, 20:08:27


